Object.defineProperty(exports, "__esModule", { value: true });
// angular
var testing_1 = require("@angular/core/testing");
var testing_2 = require("@angular/router/testing");
// libs
var angulartics2_1 = require("angulartics2");
// app
var index_1 = require("../test/index");
// module
var service_1 = require("./service");
var testModuleConfig = function () {
    testing_1.TestBed.configureTestingModule({
        imports: [
            testing_2.RouterTestingModule,
            angulartics2_1.Angulartics2Module.forRoot([
                angulartics2_1.Angulartics2Segment
            ])
        ],
        providers: [
            service_1.AnalyticsService
        ]
    });
};
function main() {
    index_1.t.describe('analytics:', function () {
        index_1.t.be(testModuleConfig);
        index_1.t.describe('AnalyticsService', function () {
            index_1.t.describe('api works', function () {
                index_1.t.it('track', index_1.t.inject([service_1.AnalyticsService, angulartics2_1.Angulartics2Segment], function (analyticsService, segment) {
                    analyticsService.devMode(false);
                    index_1.t.spyOn(segment, 'eventTrack');
                    analyticsService.track('click', { category: 'TEST', label: 'Testing' });
                    index_1.t.e(segment.eventTrack).toHaveBeenCalledWith('click', { category: 'TEST', label: 'Testing' });
                }));
                index_1.t.it('track devMode: ON', index_1.t.inject([service_1.AnalyticsService, angulartics2_1.Angulartics2Segment], function (analyticsService, segment) {
                    index_1.t.spyOn(segment, 'eventTrack');
                    // dev mode: shouldn't track anything
                    analyticsService.devMode(true);
                    analyticsService.track('click', { category: 'TEST', label: 'Testing' });
                    index_1.t.e(segment.eventTrack).not.toHaveBeenCalled();
                }));
                index_1.t.it('pageTrack', index_1.t.inject([service_1.AnalyticsService, angulartics2_1.Angulartics2Segment], function (analyticsService, segment) {
                    index_1.t.spyOn(segment, 'pageTrack');
                    analyticsService.pageTrack('/testing', {});
                    index_1.t.e(segment.pageTrack).toHaveBeenCalledWith('/testing', {});
                }));
                index_1.t.it('pageTrack devMode: ON', index_1.t.inject([service_1.AnalyticsService, angulartics2_1.Angulartics2Segment], function (analyticsService, segment) {
                    index_1.t.spyOn(segment, 'pageTrack');
                    // dev mode: shouldn't track anything
                    analyticsService.devMode(true);
                    analyticsService.pageTrack('/testing', {});
                    index_1.t.e(segment.pageTrack).not.toHaveBeenCalled();
                }));
                index_1.t.it('identify', index_1.t.inject([service_1.AnalyticsService, angulartics2_1.Angulartics2Segment], function (analyticsService, segment) {
                    index_1.t.spyOn(segment, 'setUserProperties');
                    analyticsService.identify({ userId: 1, name: 'Test', email: 'name@domain.com' });
                    index_1.t.e(segment.setUserProperties).toHaveBeenCalledWith({ userId: 1, name: 'Test', email: 'name@domain.com' });
                }));
                index_1.t.it('identify devMode: ON', index_1.t.inject([service_1.AnalyticsService, angulartics2_1.Angulartics2Segment], function (analyticsService, segment) {
                    index_1.t.spyOn(segment, 'setUserProperties');
                    // dev mode: shouldn't track anything
                    analyticsService.devMode(true);
                    analyticsService.identify({ userId: 1, name: 'Test', email: 'name@domain.com' });
                    index_1.t.e(segment.setUserProperties).not.toHaveBeenCalled();
                }));
            });
        });
        index_1.t.describe('Analytics (Base Class)', function () {
            index_1.t.describe('should allow descendants to track actions', function () {
                index_1.t.it('track', index_1.t.inject([service_1.AnalyticsService, angulartics2_1.Angulartics2Segment], function (analyticsService, segment) {
                    index_1.t.spyOn(analyticsService, 'track');
                    var analytics = new TestAnalytics(analyticsService);
                    analytics.category = 'TEST';
                    analytics.track('action', { category: analytics.category, label: 'Testing' });
                    index_1.t.e(analyticsService.track).toHaveBeenCalledWith('action', { category: analytics.category, label: 'Testing' });
                }));
            });
        });
    });
}
exports.main = main;
var TestAnalytics = (function (_super) {
    __extends(TestAnalytics, _super);
    function TestAnalytics() {
        return _super !== null && _super.apply(this, arguments) || this;
    }
    return TestAnalytics;
}(service_1.Analytics));

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImFwcC9tb2R1bGVzL2FuYWx5dGljcy9zcGVjLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxVQUFVO0FBQ1YsaURBQWdEO0FBQ2hELG1EQUE4RDtBQUU5RCxPQUFPO0FBQ1AsNkNBQXVFO0FBRXZFLE1BQU07QUFDTix1Q0FBa0M7QUFFbEMsU0FBUztBQUNULHFDQUF3RDtBQUV4RCxJQUFNLGdCQUFnQixHQUFHO0lBQ3JCLGlCQUFPLENBQUMsc0JBQXNCLENBQUM7UUFDM0IsT0FBTyxFQUFFO1lBQ0wsNkJBQW1CO1lBQ25CLGlDQUFrQixDQUFDLE9BQU8sQ0FBQztnQkFDdkIsa0NBQW1CO2FBQ3RCLENBQUM7U0FDTDtRQUNELFNBQVMsRUFBRTtZQUNQLDBCQUFnQjtTQUNuQjtLQUNKLENBQUMsQ0FBQztBQUNQLENBQUMsQ0FBQztBQUVGO0lBQ0ksU0FBQyxDQUFDLFFBQVEsQ0FBQyxZQUFZLEVBQUU7UUFFckIsU0FBQyxDQUFDLEVBQUUsQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDO1FBRXZCLFNBQUMsQ0FBQyxRQUFRLENBQUMsa0JBQWtCLEVBQUU7WUFFM0IsU0FBQyxDQUFDLFFBQVEsQ0FBQyxXQUFXLEVBQUU7Z0JBQ3BCLFNBQUMsQ0FBQyxFQUFFLENBQUMsT0FBTyxFQUFFLFNBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQywwQkFBZ0IsRUFBRSxrQ0FBbUIsQ0FBQyxFQUFFLFVBQUMsZ0JBQXFCLEVBQUUsT0FBWTtvQkFDaEcsZ0JBQWdCLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxDQUFDO29CQUNoQyxTQUFDLENBQUMsS0FBSyxDQUFDLE9BQU8sRUFBRSxZQUFZLENBQUMsQ0FBQztvQkFDL0IsZ0JBQWdCLENBQUMsS0FBSyxDQUFDLE9BQU8sRUFBRSxFQUFFLFFBQVEsRUFBRSxNQUFNLEVBQUUsS0FBSyxFQUFFLFNBQVMsRUFBRSxDQUFDLENBQUM7b0JBQ3hFLFNBQUMsQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLFVBQVUsQ0FBQyxDQUFDLG9C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QyxRQUFRLEVBQUUsS0FBSyxFQUFFLFNBQVMsRUFBRSxDQUFDLENBQUM7Z0JBQ25ILENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDUixDQUFDLENBQUMsQ0FBQztRQUNQLENBQUMsQ0FBQyxDQUFDO0lBQ1AsQ0FBQyxDQUFDLENBQUM7QUFDUCxDQUFDO0FBaEVELG9CQWdFQztBQUVEO0lBQTRCLGlDQUFTO0lBQXJDOztJQUF3QyxDQUFDO0lBQUQsb0JBQUM7QUFBRCxDQUF4QyxBQUF5QyxDQUFiLG1CQUFTLEdBQUkiLCJmaWxlIjoiYXBwL21vZHVsZXMvYW5hbHl0aWNzL3NwZWMuanMiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBhbmd1bGFyXG5pbXBvcnQgeyBUZXN0QmVkIH0gZnJvbSAnQGFuZ3VsYXIvY29yZS90ZXN0aW5nJztcbmltcG9ydCB7IFJvdXRlclRlc3RpbmdNb2R1bGUgfSBmcm9tICdAYW5ndWxhci9yb3V0ZXIvdGVzdGluZyc7XG5cbi8vIGxpYnNcbmltcG9ydCB7IEFuZ3VsYXJ0aWNzMk1vZHVsZSwgQW5ndWxhcnRpY3MyU2VnbWVudCB9IGZyb20gJ2FuZ3VsYXJ0aWNzMic7XG5cbi8vIGFwcFxuaW1wb3J0IHsgdCB9IGZyb20gJy4uL3Rlc3QvaW5kZXgnO1xuXG4vLyBtb2R1bGVcbmltcG9ydCB7IEFuYWx5dGljc1NlcnZpY2UsIEFuYWx5dGljcyB9IGZyb20gJy4vc2VydmljZSc7XG5cbmNvbnN0IHRlc3RNb2R1bGVDb25maWcgPSAoKSA9PiB7XG4gICAgVGVzdEJlZC5jb25maWd1cmVUZXN0aW5nTW9kdWxlKHtcbiAgICAgICAgaW1wb3J0czogW1xuICAgICAgICAgICAgUm91dGVyVGVzdGluZ01vZHVsZSxcbiAgICAgICAgICAgIEFuZ3VsYXJ0aWNzMk1vZHVsZS5mb3JSb290KFtcbiAgICAgICAgICAgICAgICBBbmd1bGFydGljczJTZWdtZW50XG4gICAgICAgICAgICBdKVxuICAgICAgICBdLFxuICAgICAgICBwcm92aWRlcnM6IFtcbiAgICAgICAgICAgIEFuYWx5dGljc1NlcnZpY2VcbiAgICAgICAgXVxuICAgIH0pO1xufTtcblxuZXhwb3J0IGZ1bmN0aW9uIG1haW4oKSB7XG4gICAgdC5kZXNjcmliZSgnYW5hbHl0aWNzOicsICgpID0+IHtcblxuICAgICAgICB0LmJlKHRlc3RNb2R1bGVDb25maWcpO1xuXG4gICAgICAgIHQuZGVzY3JpYmUoJ0FuYWx5dGljc1NlcnZpY2UnLCAoKSA9PiB7XG5cbiAgICAgICAgICAgIHQuZGVzY3JpYmUoJ2FwaSB3b3JrcycsICgpID0+IHtcbiAgICAgICAgICAgICAgICB0Lml0KCd0cmFjaycsIHQuaW5qZWN0KFtBbmFseXRpY3NTZXJ2aWNlLCBBbmd1bGFydGljczJTZWdtZW50XSwgKGFuYWx5dGljc1NlcnZpY2U6IGFueSwgc2VnbWVudDogYW55KSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGFuYWx5dGljc1NlcnZpY2UuZGV2TW9kZShmYWxzZSk7XG4gICAgICAgICAgICAgICAgICAgIHQuc3B5T24oc2VnbWVudCwgJ2V2ZW50VHJhY2snKTtcbiAgICAgICAgICAgICAgICAgICAgYW5hbHl0aWNzU2VydmljZS50cmFjaygnY2xpY2snLCB7IGNhdGVnb3J5OiAnVEVTVCcsIGxhYmVsOiAnVGVzdGluZycgfSk7XG4gICAgICAgICAgICAgICAgICAgIHQuZShzZWdtZW50LmV2ZW50VHJhY2spLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKCdjbGljaycsIHsgY2F0ZWdvcnk6ICdURVNUJywgbGFiZWw6ICdUZXN0aW5nJyB9KTtcbiAgICAgICAgICAgICAgICB9KSk7XG4gICAgICAgICAgICAgICAgdC5pdCgndHJhY2sgZGV2TW9kZTogT04nLCB0LmluamVjdChbQW5hbHl0aWNzU2VydmljZSwgQW5ndWxhcnRpY3MyU2VnbWVudF0sIChhbmFseXRpY3NTZXJ2aWNlOiBhbnksIHNlZ21lbnQ6IGFueSkgPT4ge1xuICAgICAgICAgICAgICAgICAgICB0LnNweU9uKHNlZ21lbnQsICdldmVudFRyYWNrJyk7XG5cbiAgICAgICAgICAgICAgICAgICAgLy8gZGV2IG1vZGU6IHNob3VsZG4ndCB0cmFjayBhbnl0aGluZ1xuICAgICAgICAgICAgICAgICAgICBhbmFseXRpY3NTZXJ2aWNlLmRldk1vZGUodHJ1ZSk7XG4gICAgICAgICAgICAgICAgICAgIGFuYWx5dGljc1NlcnZpY2UudHJhY2soJ2NsaWNrJywgeyBjYXRlZ29yeTogJ1RFU1QnLCBsYWJlbDogJ1Rlc3RpbmcnIH0pO1xuICAgICAgICAgICAgICAgICAgICB0LmUoc2VnbWVudC5ldmVudFRyYWNrKS5ub3QudG9IYXZlQmVlbkNhbGxlZCgpO1xuICAgICAgICAgICAgICAgIH0pKTtcbiAgICAgICAgICAgICAgICB0Lml0KCdwYWdlVHJhY2snLCB0LmluamVjdChbQW5hbHl0aWNzU2VydmljZSwgQW5ndWxhcnRpY3MyU2VnbWVudF0sIChhbmFseXRpY3NTZXJ2aWNlOiBhbnksIHNlZ21lbnQ6IGFueSkgPT4ge1xuICAgICAgICAgICAgICAgICAgICB0LnNweU9uKHNlZ21lbnQsICdwYWdlVHJhY2snKTtcbiAgICAgICAgICAgICAgICAgICAgYW5hbHl0aWNzU2VydmljZS5wYWdlVHJhY2soJy90ZXN0aW5nJywge30pO1xuICAgICAgICAgICAgICAgICAgICB0LmUoc2VnbWVudC5wYWdlVHJhY2spLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKCcvdGVzdGluZycsIHt9KTtcbiAgICAgICAgICAgICAgICB9KSk7XG4gICAgICAgICAgICAgICAgdC5pdCgncGFnZVRyYWNrIGRldk1vZGU6IE9OJywgdC5pbmplY3QoW0FuYWx5dGljc1NlcnZpY2UsIEFuZ3VsYXJ0aWNzMlNlZ21lbnRdLCAoYW5hbHl0aWNzU2VydmljZTogYW55LCBzZWdtZW50OiBhbnkpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgdC5zcHlPbihzZWdtZW50LCAncGFnZVRyYWNrJyk7XG5cbiAgICAgICAgICAgICAgICAgICAgLy8gZGV2IG1vZGU6IHNob3VsZG4ndCB0cmFjayBhbnl0aGluZ1xuICAgICAgICAgICAgICAgICAgICBhbmFseXRpY3NTZXJ2aWNlLmRldk1vZGUodHJ1ZSk7XG4gICAgICAgICAgICAgICAgICAgIGFuYWx5dGljc1NlcnZpY2UucGFnZVRyYWNrKCcvdGVzdGluZycsIHt9KTtcbiAgICAgICAgICAgICAgICAgICAgdC5lKHNlZ21lbnQucGFnZVRyYWNrKS5ub3QudG9IYXZlQmVlbkNhbGxlZCgpO1xuICAgICAgICAgICAgICAgIH0pKTtcbiAgICAgICAgICAgICAgICB0Lml0KCdpZGVudGlmeScsIHQuaW5qZWN0KFtBbmFseXRpY3NTZXJ2aWNlLCBBbmd1bGFydGljczJTZWdtZW50XSwgKGFuYWx5dGljc1NlcnZpY2U6IGFueSwgc2VnbWVudDogYW55KSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIHQuc3B5T24oc2VnbWVudCwgJ3NldFVzZXJQcm9wZXJ0aWVzJyk7XG4gICAgICAgICAgICAgICAgICAgIGFuYWx5dGljc1NlcnZpY2UuaWRlbnRpZnkoeyB1c2VySWQ6IDEsIG5hbWU6ICdUZXN0JywgZW1haWw6ICduYW1lQGRvbWFpbi5jb20nIH0pO1xuICAgICAgICAgICAgICAgICAgICB0LmUoc2VnbWVudC5zZXRVc2VyUHJvcGVydGllcykudG9IYXZlQmVlbkNhbGxlZFdpdGgoeyB1c2VySWQ6IDEsIG5hbWU6ICdUZXN0JywgZW1haWw6ICduYW1lQGRvbWFpbi5jb20nIH0pO1xuICAgICAgICAgICAgICAgIH0pKTtcbiAgICAgICAgICAgICAgICB0Lml0KCdpZGVudGlmeSBkZXZNb2RlOiBPTicsIHQuaW5qZWN0KFtBbmFseXRpY3NTZXJ2aWNlLCBBbmd1bGFydGljczJTZWdtZW50XSwgKGFuYWx5dGljc1NlcnZpY2U6IGFueSwgc2VnbWVudDogYW55KSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIHQuc3B5T24oc2VnbWVudCwgJ3NldFVzZXJQcm9wZXJ0aWVzJyk7XG5cbiAgICAgICAgICAgICAgICAgICAgLy8gZGV2IG1vZGU6IHNob3VsZG4ndCB0cmFjayBhbnl0aGluZ1xuICAgICAgICAgICAgICAgICAgICBhbmFseXRpY3NTZXJ2aWNlLmRldk1vZGUodHJ1ZSk7XG4gICAgICAgICAgICAgICAgICAgIGFuYWx5dGljc1NlcnZpY2UuaWRlbnRpZnkoeyB1c2VySWQ6IDEsIG5hbWU6ICdUZXN0JywgZW1haWw6ICduYW1lQGRvbWFpbi5jb20nIH0pO1xuICAgICAgICAgICAgICAgICAgICB0LmUoc2VnbWVudC5zZXRVc2VyUHJvcGVydGllcykubm90LnRvSGF2ZUJlZW5DYWxsZWQoKTtcbiAgICAgICAgICAgICAgICB9KSk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgdC5kZXNjcmliZSgnQW5hbHl0aWNzIChCYXNlIENsYXNzKScsICgpID0+IHtcblxuICAgICAgICAgICAgdC5kZXNjcmliZSgnc2hvdWxkIGFsbG93IGRlc2NlbmRhbnRzIHRvIHRyYWNrIGFjdGlvbnMnLCAoKSA9PiB7XG4gICAgICAgICAgICAgICAgdC5pdCgndHJhY2snLCB0LmluamVjdChbQW5hbHl0aWNzU2VydmljZSwgQW5ndWxhcnRpY3MyU2VnbWVudF0sIChhbmFseXRpY3NTZXJ2aWNlOiBhbnksIHNlZ21lbnQ6IGFueSkgPT4ge1xuICAgICAgICAgICAgICAgICAgICB0LnNweU9uKGFuYWx5dGljc1NlcnZpY2UsICd0cmFjaycpO1xuICAgICAgICAgICAgICAgICAgICBsZXQgYW5hbHl0aWNzID0gbmV3IFRlc3RBbmFseXRpY3MoYW5hbHl0aWNzU2VydmljZSk7XG4gICAgICAgICAgICAgICAgICAgIGFuYWx5dGljcy5jYXRlZ29yeSA9ICdURVNUJztcbiAgICAgICAgICAgICAgICAgICAgYW5hbHl0aWNzLnRyYWNrKCdhY3Rpb24nLCB7IGNhdGVnb3J5OiBhbmFseXRpY3MuY2F0ZWdvcnksIGxhYmVsOiAnVGVzdGluZycgfSk7XG4gICAgICAgICAgICAgICAgICAgIHQuZShhbmFseXRpY3NTZXJ2aWNlLnRyYWNrKS50b0hhdmVCZWVuQ2FsbGVkV2l0aCgnYWN0aW9uJywgeyBjYXRlZ29yeTogYW5hbHl0aWNzLmNhdGVnb3J5LCBsYWJlbDogJ1Rlc3RpbmcnIH0pO1xuICAgICAgICAgICAgICAgIH0pKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9KTtcbiAgICB9KTtcbn1cblxuY2xhc3MgVGVzdEFuYWx5dGljcyBleHRlbmRzIEFuYWx5dGljcyB7IH1cbiJdfQ==
