Object.defineProperty(exports, "__esModule", { value: true });
// libs
var core_1 = require("@angular/core");
var forms_1 = require("@angular/forms");
var router_1 = require("@angular/router");
// app
var services_1 = require("../../../core/services/api/services");
var index_1 = require("../../../core/index");
// map
var MapBox = require("mapbox-gl");
//import * as MapBoxGeocoder from '@mapbox/mapbox-gl-geocoder';
var WebMapComponent = (function () {
    function WebMapComponent(apiService, fb, apiOptions, route, router) {
        var _this = this;
        this.apiService = apiService;
        this.fb = fb;
        this.apiOptions = apiOptions;
        this.route = route;
        this.router = router;
        this.loading = true;
        this.model = [];
        this.options = {
            accessToken: index_1.Config.ENVIRONMENT().MAP_BOX_API_KEY,
            map: '',
            options: {
                container: 'map',
                style: 'mapbox://styles/mapbox/light-v9',
                center: [152.994306, -26.612273],
                zoom: 13,
                hash: false,
                interactive: false
            }
        };
        this.marker = {
            id: 'marker',
            offset: [-25, -25],
            latLang: [0, 0],
            popup: {
                offset: 25,
                text: ''
            }
        };
        this.markers = [];
        this.onCreateMarker = function () {
            _this.marker.latLang = _this.options.options.center;
            _this.marker.popup.text = 'testing';
            return _this.marker;
        };
        this.onCreateMarkerPopup = function (options) {
            var popup = new MapBox.Popup({ offset: options.offset })
                .setText(options.text);
            return popup;
        };
    }
    WebMapComponent.prototype.ngOnInit = function () {
        this.loading = true;
        //this.onSetLocation(this.options);
        this.returnUrl = this.route.snapshot.queryParams[index_1.Config.ROUTE_PARAMETERS.LOGIN_RETURN_URL] || '/';
        this.options.options.center = [index_1.Config.ROUTE_PARAMETERS.LONGITUDE, index_1.Config.ROUTE_PARAMETERS.LATITUDE];
        this.onMapComponentInit(this.options);
    };
    WebMapComponent.prototype.onMapComponentInit = function (options) {
        this.onAssign(MapBox, 'accessToken', options.accessToken);
        options.map = new MapBox.Map(options.options);
        this.onSetCentre(options);
    };
    WebMapComponent.prototype.onSetCentre = function (options) {
        this.loading = true;
        options.map.setCenter(options.options.center);
        this.onRemoveMarker(this.markers);
        this.onAddMarkers(this.onCreateMarker());
    };
    WebMapComponent.prototype.onRemoveMarker = function (markers) {
        var self = this;
        markers.forEach(function (mark, index) {
            mark.remove();
            markers.splice(index, 1);
        }, this);
    };
    WebMapComponent.prototype.onAddMarkers = function (marker) {
        var el = document.createElement('div');
        el.id = marker.id;
        this.markers.push(new MapBox.Marker(el, { offset: marker.offset })
            .setLngLat(marker.latLang)
            .setPopup(this.onCreateMarkerPopup(marker.popup))
            .addTo(this.options.map));
        this.loading = !this.loading;
    };
    WebMapComponent.prototype.onAssign = function (obj, prop, value) {
        if (typeof prop === 'string')
            prop = prop.split('.');
        if (prop.length > 1) {
            var e = prop.shift();
            this.onAssign(obj[e] =
                Object.prototype.toString.call(obj[e]) === '[object Object]'
                    ? obj[e]
                    : {}, prop, value);
        }
        else
            obj[prop[0]] = value;
    };
    return WebMapComponent;
}());
WebMapComponent = __decorate([
    core_1.Component({
        moduleId: module.id,
        selector: 'sd-map',
        templateUrl: index_1.Config.COMPONENT_ITEMS.TEMPLATE,
        styleUrls: [index_1.Config.COMPONENT_ITEMS.CSS],
    }),
    __metadata("design:paramtypes", [services_1.ApiService,
        forms_1.FormBuilder,
        index_1.ApiServiceParametersOptions,
        router_1.ActivatedRoute,
        router_1.Router])
], WebMapComponent);
exports.WebMapComponent = WebMapComponent;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImFwcC9tb2R1bGVzL21hcC9jb21wb25lbnRzL21hcC9jb21wb25lbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE9BQU87QUFDUCxzQ0FBNkQ7QUFDN0Qsd0NBQWlGO0FBQ2pGLDBDQUF5RDtBQUV6RCxNQUFNO0FBQ04sZ0VBQWlFO0FBRWpFLDZDQUEwRTtBQUsxRSxNQUFNO0FBQ04sa0NBQW9DO0FBQ3BDLCtEQUErRDtBQVEvRCxJQUFhLGVBQWU7SUErQnhCLHlCQUNXLFVBQXNCLEVBQ3JCLEVBQWUsRUFDZixVQUF1QyxFQUN2QyxLQUFxQixFQUNyQixNQUFjO1FBTDFCLGlCQUsrQjtRQUpwQixlQUFVLEdBQVYsVUFBVSxDQUFZO1FBQ3JCLE9BQUUsR0FBRixFQUFFLENBQWE7UUFDZixlQUFVLEdBQVYsVUFBVSxDQUE2QjtRQUN2QyxVQUFLLEdBQUwsS0FBSyxDQUFnQjtRQUNyQixXQUFNLEdBQU4sTUFBTSxDQUFRO1FBakNuQixZQUFPLEdBQVksSUFBSSxDQUFDO1FBRXZCLFVBQUssR0FBUSxFQUFFLENBQUM7UUFHaEIsWUFBTyxHQUFjO1lBQ3pCLFdBQVcsRUFBRSxjQUFNLENBQUMsV0FBVyxFQUFFLENBQUMsZUFBZTtZQUNqRCxHQUFHLEVBQUUsRUFBRTtZQUNQLE9BQU8sRUFBRTtnQkFDTCxTQUFTLEVBQUUsS0FBSztnQkFDaEIsS0FBSyxFQUFFLGlDQUFpQztnQkFDeEMsTUFBTSxFQUFFLENBQUMsVUFBVSxFQUFFLENBQUMsU0FBUyxDQUFDO2dCQUNoQyxJQUFJLEVBQUUsRUFBRTtnQkFDUixJQUFJLEVBQUUsS0FBSztnQkFDWCxXQUFXLEVBQUUsS0FBSzthQUNyQjtTQUNKLENBQUM7UUFDTSxXQUFNLEdBQVk7WUFDdEIsRUFBRSxFQUFFLFFBQVE7WUFDWixNQUFNLEVBQUUsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLEVBQUUsQ0FBQztZQUNsQixPQUFPLEVBQUUsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDO1lBQ2YsS0FBSyxF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Q0FBQyxRQUFRO1FBQzVDLFNBQVMsRUFBRSxDQUFDLGNBQU0sQ0FBQyxlQUFlLENBQUMsR0FBRyxDQUFDO0tBQzFDLENBQUM7cUNBaUN5QixxQkFBVTtRQUNqQixtQkFBVztRQUNILG1DQUEyQjtRQUNoQyx1QkFBYztRQUNiLGVBQU07R0FwQ2pCLGVBQWUsQ0E0RzNCO0FBNUdZLDBDQUFlIiwiZmlsZSI6ImFwcC9tb2R1bGVzL21hcC9jb21wb25lbnRzL21hcC9jb21wb25lbnQuanMiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBsaWJzXHJcbmltcG9ydCB7IENvbXBvbmVudCwgT25Jbml0LCBPbkRlc3Ryb3kgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuaW1wb3J0IHsgRm9ybUdyb3VwLCBGb3JtQ29udHJvbCwgRm9ybUJ1aWxkZXIsIFZhbGlkYXRvcnMgfSBmcm9tICdAYW5ndWxhci9mb3Jtcyc7XHJcbmltcG9ydCB7IFJvdXRlciwgQWN0aXZhdGVkUm91dGUgfSBmcm9tICdAYW5ndWxhci9yb3V0ZXInO1xyXG5cclxuLy8gYXBwXHJcbmltcG9ydCB7IEFwaVNlcnZpY2UgfSBmcm9tICcuLi8uLi8uLi9jb3JlL3NlcnZpY2VzL2FwaS9zZXJ2aWNlcyc7XHJcbmltcG9ydCB7IElDb29yZGluYXRlcywgSU1hcFF1ZXJ5LCBJTWFwRmVhdHVyZXMsIElNYXBTZXR1cCwgSU1hcE9wdGlvbnMsIElNYXJrZXIsIElQb3B1cCB9IGZyb20gJy4uLy4uL2luZGV4JztcclxuaW1wb3J0IHsgQ29uZmlnLCBBcGlTZXJ2aWNlUGFyYW1ldGVyc09wdGlvbnMgfSBmcm9tICcuLi8uLi8uLi9jb3JlL2luZGV4JztcclxuXHJcblxyXG5pbXBvcnQgeyBPYnNlcnZhYmxlIH0gZnJvbSAncnhqcy9PYnNlcnZhYmxlJztcclxuXHJcbi8vIG1hcFxyXG5pbXBvcnQgKiBhcyBNYXBCb3ggZnJvbSAnbWFwYm94LWdsJztcclxuLy9pbXBvcnQgKiBhcyBNYXBCb3hHZW9jb2RlciBmcm9tICdAbWFwYm94L21hcGJveC1nbC1nZW9jb2Rlcic7XHJcblxyXG5AQ29tcG9uZW50KHtcclxuICAgIG1vZHVsZUlkOiBtb2R1bGUuaWQsXHJcbiAgICBzZWxlY3RvcjogJ3NkLW1hcCcsXHJcbiAgICB0ZW1wbGF0ZVVybDogQ29uZmlnLkNPTVBPTkVOVF9JVEVNUy5URU1QTEFURSxcclxuICAgIHN0eWxlVXJsczogW0NvbmZpZy5DT01QT05FTlRfSVRFTVMuQ1NTXSxcclxufSlcclxuZXhwb3J0IGNsYXNzIFdlYk1hcENvbXBvbmVudCBpbXBsZW1lbnRzIE9uSW5pdCB7XHJcblxyXG4gICAgcHVibGljIG1hcDogYW55O1xyXG4gICAgcHVibGljIGxvYWRpbmc6IGJvb2xlYW4gPSB0cnVlO1xyXG5cclxuICAgIHByaXZhdGUgbW9kZWw6IGFueSA9IFtdO1xyXG4gICAgcHJpdmF0ZSBlcnJvck1lc3NhZ2U6IHN0cmluZztcclxuICAgIHByaXZhdGUgcmV0dXJuVXJsOiBzdHJpbmc7XHJcbiAgICBwcml2YXRlIG9wdGlvbnM6IElNYXBTZXR1cCA9IHtcclxuICAgICAgICBhY2Nlc3NUb2tlbjogQ29uZmlnLkVOVklST05NRU5UKCkuTUFQX0JPWF9BUElfS0VZLFxyXG4gICAgICAgIG1hcDogJycsXHJcbiAgICAgICAgb3B0aW9uczoge1xyXG4gICAgICAgICAgICBjb250YWluZXI6ICdtYXAnLFxyXG4gICAgICAgICAgICBzdHlsZTogJ21hcGJveDovL3N0eWxlcy9tYXBib3gvbGlnaHQtdjknLFxyXG4gICAgICAgICAgICBjZW50ZXI6IFsxNTIuOTk0MzA2LCAtMjYuNjEyMjczXSxcclxuICAgICAgICAgICAgem9vbTogMTMsXHJcbiAgICAgICAgICAgIGhhc2g6IGZhbHNlLFxyXG4gICAgICAgICAgICBpbnRlcmFjdGl2ZTogZmFsc2VcclxuICAgICAgICB9XHJcbiAgICB9O1xyXG4gICAgcHJpdmF0ZSBtYXJrZXI6IElNYXJrZXIgPSB7XHJcbiAgICAgICAgaWQ6ICdtYXJrZXInLFxyXG4gICAgICAgIG9mZnNldDogWy0yNSwgLTI1XSxcclxuICAgICAgICBsYXRMYW5nOiBbMCwgMF0sXHJcbiAgICAgICAgcG9wdXA6IHtcclxuICAgICAgICAgICAgb2Zmc2V0OiAyNSxcclxuICAgICAgICAgICAgdGV4dDogJydcclxuICAgICAgICB9XHJcbiAgICB9O1xyXG4gICAgcHJpdmF0ZSBtYXJrZXJzOiBJTWFya2VyW10gPSBbXTtcclxuXHJcbiAgICBjb25zdHJ1Y3RvcihcclxuICAgICAgICBwdWJsaWMgYXBpU2VydmljZTogQXBpU2VydmljZSxcclxuICAgICAgICBwcml2YXRlIGZiOiBGb3JtQnVpbGRlcixcclxuICAgICAgICBwcml2YXRlIGFwaU9wdGlvbnM6IEFwaVNlcnZpY2VQYXJhbWV0ZXJzT3B0aW9ucyxcclxuICAgICAgICBwcml2YXRlIHJvdXRlOiBBY3RpdmF0ZWRSb3V0ZSxcclxuICAgICAgICBwcml2YXRlIHJvdXRlcjogUm91dGVyKSB7IH1cclxuXHJcbiAgICBuZ09uSW5pdCgpIHtcclxuICAgICAgICB0aGlzLmxvYWRpbmcgPSB0cnVlO1xyXG4gICAgICAgIC8vdGhpcy5vblNldExvY2F0aW9uKHRoaXMub3B0aW9ucyk7XHJcbiAgICAgICAgdGhpcy5yZXR1cm5VcmwgPSB0aGlzLnJvdXRlLnNuYXBzaG90LnF1ZXJ5UGFyYW1zW0NvbmZpZy5ST1VURV9QQVJBTUVURVJTLkxPR0lOX1JFVFVSTl9VUkxdIHx8ICcvJztcclxuICAgICAgICB0aGlzLm9wdGlvbnMub3B0aW9ucy5jZW50ZXIgPSBbQ29uZmlnLlJPVVRFX1BBUkFNRVRFUlMuTE9OR0lUVURFLCBDb25maWcuUk9VVEVfUEFSQU1FVEVSUy5MQVRJVFVERV07XHJcbiAgICAgICAgdGhpcy5vbk1hcENvbXBvbmVudEluaXQodGhpcy5vcHRpb25zKTtcclxuICAgIH1cclxuXHJcbiAgICBvbk1hcENvbXBvbmVudEluaXQob3B0aW9uczogSU1hcFNldHVwKSB7XHJcbiAgICAgICAgdGhpcy5vbkFzc2lnbihNYXBCb3gsICdhY2Nlc3NUb2tlbicsIG9wdGlvbnMuYWNjZXNzVG9rZW4pO1xyXG4gICAgICAgIG9wdGlvbnMubWFwID0gbmV3IE1hcEJveC5NYXAob3B0aW9ucy5vcHRpb25zKTtcclxuICAgICAgICB0aGlzLm9uU2V0Q2VudHJlKG9wdGlvbnMpO1xyXG4gICAgfVxyXG5cclxuICAgIG9uU2V0Q2VudHJlKG9wdGlvbnM6IElNYXBTZXR1cCkge1xyXG4gICAgICAgIHRoaXMubG9hZGluZyA9IHRydWU7XHJcbiAgICAgICAgb3B0aW9ucy5tYXAuc2V0Q2VudGVyKG9wdGlvbnMub3B0aW9ucy5jZW50ZXIpO1xyXG4gICAgICAgIHRoaXMub25SZW1vdmVNYXJrZXIodGhpcy5tYXJrZXJzKTtcclxuICAgICAgICB0aGlzLm9uQWRkTWFya2Vycyh0aGlzLm9uQ3JlYXRlTWFya2VyKCkpO1xyXG4gICAgfVxyXG5cclxuICAgIG9uQ3JlYXRlTWFya2VyID0gKCk6IElNYXJrZXIgPT4ge1xyXG4gICAgICAgIHRoaXMubWFya2VyLmxhdExhbmcgPSB0aGlzLm9wdGlvbnMub3B0aW9ucy5jZW50ZXI7XHJcbiAgICAgICAgdGhpcy5tYXJrZXIucG9wdXAudGV4dCA9ICd0ZXN0aW5nJztcclxuXHJcbiAgICAgICAgcmV0dXJuIHRoaXMubWFya2VyO1xyXG4gICAgfVxyXG5cclxuICAgIG9uUmVtb3ZlTWFya2VyKG1hcmtlcnM6IGFueVtdKSB7XHJcbiAgICAgICAgbGV0IHNlbGYgPSB0aGlzO1xyXG4gICAgICAgIG1hcmtlcnMuZm9yRWFjaCgobWFyazogYW55LCBpbmRleDogbnVtYmVyKSA9PiB7XHJcbiAgICAgICAgICAgIG1hcmsucmVtb3ZlKCk7XHJcbiAgICAgICAgICAgIG1hcmtlcnMuc3BsaWNlKGluZGV4LCAxKTtcclxuICAgICAgICB9LCB0aGlzKTsgICAgICBcclxuICAgIH1cclxuXHJcbiAgICBvbkFkZE1hcmtlcnMobWFya2VyOiBJTWFya2VyKSB7XHJcbiAgICAgICAgbGV0IGVsID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7XHJcbiAgICAgICAgZWwuaWQgPSBtYXJrZXIuaWQ7XHJcblxyXG4gICAgICAgIHRoaXMubWFya2Vycy5wdXNoKG5ldyBNYXBCb3guTWFya2VyKGVsLCB7IG9mZnNldDogbWFya2VyLm9mZnNldCB9KVxyXG4gICAgICAgICAgICAuc2V0TG5nTGF0KG1hcmtlci5sYXRMYW5nKVxyXG4gICAgICAgICAgICAuc2V0UG9wdXAodGhpcy5vbkNyZWF0ZU1hcmtlclBvcHVwKG1hcmtlci5wb3B1cCkpXHJcbiAgICAgICAgICAgIC5hZGRUbyh0aGlzLm9wdGlvbnMubWFwKSk7XHJcblxyXG4gICAgICAgIHRoaXMubG9hZGluZyA9ICF0aGlzLmxvYWRpbmc7XHJcbiAgICB9XHJcblxyXG4gICAgb25DcmVhdGVNYXJrZXJQb3B1cCA9IChvcHRpb25zOiBJUG9wdXApOiBhbnkgPT4ge1xyXG4gICAgICAgIGxldCBwb3B1cCA9IG5ldyBNYXBCb3guUG9wdXAoeyBvZmZzZXQ6IG9wdGlvbnMub2Zmc2V0IH0pXHJcbiAgICAgICAgICAgIC5zZXRUZXh0KG9wdGlvbnMudGV4dCk7XHJcblxyXG4gICAgICAgIHJldHVybiBwb3B1cDtcclxuICAgIH1cclxuXHJcbiAgICBvbkFzc2lnbihvYmo6IGFueSwgcHJvcDogYW55LCB2YWx1ZTogYW55KSB7XHJcbiAgICAgICAgaWYgKHR5cGVvZiBwcm9wID09PSAnc3RyaW5nJylcclxuICAgICAgICAgICAgcHJvcCA9IHByb3Auc3BsaXQoJy4nKTtcclxuXHJcbiAgICAgICAgaWYgKHByb3AubGVuZ3RoID4gMSkge1xyXG4gICAgICAgICAgICB2YXIgZSA9IHByb3Auc2hpZnQoKTtcclxuICAgICAgICAgICAgdGhpcy5vbkFzc2lnbihvYmpbZV0gPVxyXG4gICAgICAgICAgICAgICAgT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKG9ialtlXSkgPT09ICdbb2JqZWN0IE9iamVjdF0nXHJcbiAgICAgICAgICAgICAgICAgICAgPyBvYmpbZV1cclxuICAgICAgICAgICAgICAgICAgICA6IHt9LFxyXG4gICAgICAgICAgICAgICAgcHJvcCxcclxuICAgICAgICAgICAgICAgIHZhbHVlKTtcclxuICAgICAgICB9IGVsc2VcclxuICAgICAgICAgICAgb2JqW3Byb3BbMF1dID0gdmFsdWU7XHJcbiAgICB9XHJcbn1cclxuIl19
